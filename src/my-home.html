<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="shared-styles.html">

<dom-module id=my-home>
  <template>
    <style include="shared-styles">
      :host {
        opacity: 0;
        display: block;
        position: absolute;
        width: 100%;
        height: 100vh;
        top: 0;
        left: 0;
        overflow: hidden;
        padding-top: 90px;
        box-sizing: border-box;
      }

      [id^="wave-end"] {
        visibility: visible;
      }
      [id^="wave-start"],
      #circles {
        visibility: hidden;
      }
      #character svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      #character picture {
        position: relative;
      }
      #transitionBackdrop {
        position: absolute;
        width: 100%;
        height: 100vh;
        right: 0;
        bottom: -100vh;
        background-position: 100% 100%;
        background-repeat: repeat-x;
        background-image: url('/images/header-bottom-mobile.png');
        @apply --app-header;
      }
      #transitionBackdrop:after {
        content: "";
        display: block;
        position: absolute;
        z-index: 1;
        bottom: 0;
        right: 0;
        width: 100%;
        background: transparent url('/images/dashed-border-mobile.svg') 100% 100% repeat-x;
        background-size: cover;

        height: var(--app-header-height-mobile);
      }


      @media screen and (min-width: 768px) {
        :host {
          padding-top: 140px;
        }
        #transitionBackdrop {
          background-image: url('/images/header-bottom.png');
        }
        #transitionBackdrop:after {
          background-image: url('/images/dashed-border.svg');
          height: var(--app-header-height);
        }
      }
      @media screen and (min-width: 1024px) and (orientation: landscape) {
        :host {
          padding-top: 90px;
        }
      }

      @media screen and (max-width: 1439px) and (orientation: landscape) {
        /*:host {
          padding-top: 140px;
        }*/
      }


      /* Animation styles */
      /*g[id$="-layer"] {*/
        /*transition: opacity .3s ease-out;*/
      /*}*/
      /*#waves {*/
        /*transition: transform 1s ease-in-out .5s; !* we should really employ JS events for figuring out when to start the transition *!*/
      /*}*/
    </style>

    <div id="intro" class="svg-container">
      <canvas width="271" height="71"></canvas>
      <svg viewBox="0 0 271 71" xmlns="http://www.w3.org/2000/svg"><g id="Frontpage" fill="none" fill-rule="evenodd"><g id="iPhone-SE" fill="#FFF"><g id="hello"><g id="introLeft"><path id="Path" d="M0 1h22.485v26.385h21.03V1H66v68H43.515V44.458h-21.03V69H0zm75 0h58.118v17.073h-35.38v8.342h32.146v17.073H97.738v8.44H134V69H75z"/></g><g id="introRight"><path id="Path" d="M143 1h22.58v49.278H194V69h-51z"/><path d="M252.786 4.56c5.714 3.038 10.178 7.24 13.393 12.608 3.21 5.367 4.82 11.412 4.82 18.138 0 6.79-1.61 12.9-4.82 18.332-3.22 5.432-7.68 9.683-13.4 12.755C247.07 69.463 240.64 71 233.5 71c-7.143 0-13.57-1.536-19.286-4.607-5.714-3.072-10.178-7.323-13.393-12.755-3.21-5.432-4.82-11.542-4.82-18.332 0-6.79 1.61-12.868 4.82-18.235 3.22-5.36 7.68-9.55 13.4-12.56 5.71-3 12.14-4.51 19.28-4.51 7.144 0 13.57 1.52 19.287 4.56zm-25.34 16.65c-2.267 1.475-4.076 3.49-5.424 6.044-1.348 2.555-2.022 5.438-2.022 8.648s.674 6.11 2.022 8.696c1.348 2.588 3.157 4.635 5.425 6.142 2.27 1.507 4.72 2.26 7.35 2.26s5.03-.737 7.2-2.21c2.17-1.475 3.88-3.522 5.13-6.143 1.248-2.62 1.873-5.535 1.873-8.745 0-3.21-.625-6.11-1.874-8.697-1.25-2.587-2.96-4.602-5.13-6.043-2.17-1.44-4.57-2.162-7.2-2.162s-5.08.737-7.35 2.21z" id="Combined-Shape"/><path id="Path" d="M170 1h13.807v29.42H194V42h-24z"/></g></g></g></g></svg>
    </div>

    <div id="character">
      <picture>
        <source media="(max-width: 413px)"
                srcset="/images/home-mobile.png,
                    /images/home-mobile@2x.png 1.5x,
                    /images/home-mobile@2x.png 2x">
        <source media="(max-width: 599px)"
                srcset="/images/home-large-mobile.png,
                    /images/home-large-mobile@2x.png 1.5x,
                    /images/home-large-mobile@2x.png 2x">
        <source media="(max-width: 766px)"
                srcset="/images/home-small-tablet.png,
                    /images/home-small-tablet@2x.png 1.5x,
                    /images/home-small-tablet@2x.png 2x">
        <source media="(max-width: 1023px)"
                srcset="/images/home-tablet.png,
                    /images/home-tablet@2x.png 1.5x,
                    /images/home-tablet@2x.png 2x">
        <source media="(max-width: 1279px) and (orientation: landscape)"
                srcset="/images/home-tablet.png,
                    /images/home-tablet@2x.png 1.5x,
                    /images/home-tablet@2x.png 2x">
        <source srcset="/images/home.png,
                    /images/home@2x.png 1.5x,
                    /images/home@2x.png 2x">
        <img src="/images/home.png" alt="">
      </picture>
    </div>

    <div class="svg-container" id="waves">
      <canvas width="1280" height="481"></canvas>
      <svg id="wavesGroup" viewBox="0 0 1280 481" xmlns="http://www.w3.org/2000/svg"><g id="Frontpage" fill="none" fill-rule="evenodd"><g id="Animate-to-Work-1"><g id="waves"><g id="speaking-layer"><path d="M0 511h1280V25c-30.3-1.7-70.6 6.8-101.3 37.3-14.4 14.3-51.2 26.7-76.7 23-25.6-3.7-36.6-51.2-85.5-45.3-49 6-65 30.4-130.8 24.5-76.4-7-89-37-135-37C682 31 662.5 75.5 615.4 75 547.8 74 488.8 5.6 408 2c-80.8-3.6-51.3 89.2-107 87-45.2-2-69-61.6-118-61.6-40 0-35.2 29-82.7 35-64.7 8-53-20.7-81.7-32.8C14.4 27.8 6.2 25.8 0 25v486z" id="bg-end0" fill="#BEDB39"/><path d="M0 25.3c41.4 5 36.6 39 78 39 71.7 0 52.5-32.4 103.5-35.7 51-3.3 72 64.5 127.4 60.2 41-3.3 23-78 85-86.2 62-8.2 165 73.2 218 73.2 54 0 58-34.2 120-45.6 62-11.4 81 37.4 169 35.8 50-1 89-27.6 126-26 36 1.6 49 45.5 82 47.2 65 3.2 78-65 170-62" id="wave-end0" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/><path d="M1280 73.5H0" id="wave-start0" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/></g><g id="writing-layer"><path d="M1280 135.7c-30.3 1.6-36.2 28-112.6 34.7-65.8 6-81.8-18.5-130.8-24.4-49-6-60 41.5-85.5 45.2-25 3.7-62-8.7-76-23-30-30.4-72-39-103-37.3-7 1-14 3-18 4-28 12-17 40-81 32-47.4-6-42.6-35-82.5-35-49.2 0-73 60-118 61-55.7 2.2-26.3-90.5-107-86.8-81 3.7-140 72-207.5 72.7-47 1-84.3-58-156-45v376h1280V135z" id="bg-end1" fill="#1F8A70"/><path d="M0 135.4c78-11.4 102 44 157.8 44.7 55.8 2 156.2-81 218.4-73 62.2 8 44.6 85 86 88 55.4 5 76.6-65 127.6-62s32 36 103.6 36c41.4 0 30.3-33 89.3-38S888 197 942 193c33-2.2 45-43 80-47.3 35-4.3 72 27.8 134 26.2 34.7-1 94-21 124-36" id="wave-end1" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/><path d="M1280 154.5H0" id="wave-start1" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/></g><g id="working-layer"><path d="M0 511h1280V207.5l-20.7-1.5c-73.3 3.2-146 71.2-207.2 73.4-44 1.7-66-44.4-135-48-46 0-58 30.2-135 37-66 6-82-18.4-131-24.4s-60 41.6-85 45.4c-25 3.7-62-8.8-76-23-30.3-30.6-73-40.8-101-36-48 8.2-37.2 44-102 36-47.4-6-42.5-35-82.5-35-49.4 0-70.7 58-118 61.6-47.5 3.7-34-72.4-85-85.5V511z" id="bg-end2" fill="#004358"/><path d="M1280 207.7c-76.5-14.7-173.7 72.2-226.4 72.2-53.5 0-57.3-35-119.5-46-62-11-81 37-169 36-50-1-89-28-125-26-36 1-49 45-83 47-65 3-81-63-151-62s-42 34-99 38-54-36-106-36-71 63-118.5 61c-53-2-23-70-82-85" id="wave-end2" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/><path d="M1280 251.5H0" id="wave-start2" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/></g><g id="circles" transform="translate(631 65)" fill-rule="nonzero" fill="#FFF"><circle id="circle0" cx="9" cy="9" r="9"/><circle id="circle1" cx="9" cy="90" r="9"/><circle id="circle2" cx="9" cy="186" r="9"/><circle id="circle3" cx="9" cy="290" r="9"/></g></g></g></g></svg>
      <div id="transitionBackdrop"></div>
    </div>

    <div class="svg-container" id="footer-svg">
      <canvas width="1280" height="481"></canvas>
      <svg id="footerGroup" viewBox="0 0 1280 481" xmlns="http://www.w3.org/2000/svg"><g id="footer" fill="none" fill-rule="evenodd"><path d="M0 511h1280V303c-8.3-2.2-14.5-2.7-21.8-1-42.4 10-53.3 44.3-84 74.7-14.4 14.3-51.2 26.7-76.7 23-25.6-3.7-36.6-51.2-85.5-45.2-49 6-65 30.3-130.8 24.4-76.5-7-89.2-38-135.2-38-68.7 3-92 58-135.2 55-23.5-1-34.3-43-75.2-62-36.6-10.6-66.6-20-119 15.4-52.7 35.6-111.5 46-122 46-14.6 0-46.3-5.3-62.2-13.4-22-11-31.5-43-54-42.2-22.8.6-35.2 29-82.7 35-74 9-46.7-67-95.7-74v209z" id="bg-end3" fill="#F1CD00"/><path d="M2 302.8c40.7 0 21.5 59.6 71 72.6 49 13 78.2-34.2 108.6-34.2 30.3 0 36.3 61.5 115 55.4 105.2-8 129-73.4 202.6-70 71 3 87.7 68.4 115 70 39 2.4 71.7-55.4 129-55.4 54.4 0 76.8 34.2 145.4 37.5 68.4 3.3 110.2-32 143.6-24.5 43 9.8 49.5 62 105.4 44 76.6-24.5 73.4-110.8 144.4-95.4" id="wave-end3" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/><path d="M1280 354.5H0" id="wave-start3" stroke="#FFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.5 4.5"/></g></svg>
    </div>

<!--<div id="navigationBackdrop"></div>-->
  </template>

</dom-module>
<script>
  class MyHome extends Polymer.Element {
    static get is() { return 'my-home'; }

    static get properties() {
      return {
        animationConfig: {
          value: function () {
            let headerHeight = (() => {
              let height = ShadyCSS? ShadyCSS.getComputedStyleValue(this, '--app-header-height-mobile'): getComputedStyle(this, '--app-header-height-mobile');
              if (document.documentElement.clientWidth >= 768 ) {
                height = ShadyCSS? ShadyCSS.getComputedStyleValue(this, '--app-header-height'): getComputedStyle(this, '--app-header-height');
              }
              return height;
            })();
            return {
              "dissolveWaves": {
                "keyframes": [
                  {opacity: 1},
                  {opacity: 0}
                ],
                "options": {
                  duration: 500,
                  easing: "ease-out",
                  fill: "forwards"
                }
              },
              "moveWaves": {
                "keyframes": [
                  {transform: 'translateY(0)'},
                  {transform: 'translateY(-' + (document.documentElement.clientHeight * 2 - parseInt(headerHeight)) + 'px)'}
                ],
                "options": {
                  duration: 1000,
                  easing: "ease-in-out",
                  fill: "forwards"
                }
              },
              "dissolvePicture": {
                "keyframes": [
                  {opacity: 1},
                  {opacity: 0}
                ],
                "options": {
                  duration: 500,
                  easing: 'ease-in',
                  fill: "forwards"
                }
              }
            }
          }
        }
      }
    }

    ready() {
      super.ready();

      const resolvedPageUrl = this.resolveUrl('/src/frontpage.css');
      Polymer.RenderStatus.afterNextRender(this, () => {
        Polymer.importHref(
            resolvedPageUrl,
            this.injectStyles.bind(this),
            null,
            true);
      });
    }

    injectStyles(ev) {
      const styles = ev.target.import.body.innerText;
      const combo = styles + Polymer.StyleGather.cssFromModule('my-home');
      Polymer.RenderStatus.afterNextRender(this, () => {
        this.root.querySelector('style').textContent = combo;
        this.entryAnimation();
        this.__centerWaves();
      });
    }

    __centerWaves() {
      let circlesGroup = this.shadowRoot.getElementById('wavesGroup');
      let footerGroup = this.shadowRoot.getElementById('footerGroup');
      const circlesWidth = circlesGroup.getBoundingClientRect().width;
      const viewport = document.documentElement.clientWidth;
      const shift = circlesWidth - (circlesWidth / 2 + viewport / 2);

      circlesGroup.style.left = footerGroup.style.left = '-' + shift + 'px';
    }

    _prepareExitAnimation(requestedPage) {
      const layers = this.shadowRoot.querySelectorAll('g[id$="-layer"]');
      const bgs = this.shadowRoot.querySelectorAll('[id^="bg-"]');
      const requestedSection = this.shadowRoot.querySelector('g[id="' + requestedPage + '-layer"]');
      const requestedIndex = (function (lrs) {
        for (let i = 0, l = lrs.length; i < l; ++i) {
          if (lrs[i] === requestedSection) {
            return i;
          }
        }
      } )(layers);
      this.shadowRoot.getElementById('transitionBackdrop').style.backgroundColor = bgs[requestedIndex].getAttribute('fill');
      return requestedIndex;
    }

    resetExitAnimation() {
      this.shadowRoot.getElementById('transitionBackdrop').style.backgroundColor = "transparent";
      this.entryTimeline.pause(0);
    }

    entryAnimation() {
      const tl = new TimelineLite({
        paused: true
      });
      const intro = this.$.intro;
      const char = this.$.character;
      const waves = this.$.waves;

      if (this.entryTimeline) {
        this.entryTimeline.play();
//        return this.entryTimeline;
      } else {
        tl.staggerFrom([intro, char], .3, {
          'y': '100%',
          'opacity': 0,
          ease: Power3.easeOut
        })
        .from(waves, .3, {
          'opacity': 0,
          ease: Power0.easeNone
        }, "-=.1");
        this.style.setProperty('opacity', 1);
        this.entryTimeline = tl;
        tl.play();
      }
//      return tl;
    }

    exitAnimation(requestedPage) {
      if (this.exitTimeline) {
//        this.exitTimeline.play();
        return this.exitTimeline;
      }
      const requestedIndex = this._prepareExitAnimation(requestedPage);
      const layers = this.shadowRoot.querySelectorAll('g[id$="-layer"]');
      const picture = this.shadowRoot.querySelector('#character img');
      let headerHeight = (() => {
        let height = ShadyCSS? ShadyCSS.getComputedStyleValue(this, '--app-header-height-mobile'): getComputedStyle(this, '--app-header-height-mobile');
        if (document.documentElement.clientWidth >= 768 ) {
          height = ShadyCSS? ShadyCSS.getComputedStyleValue(this, '--app-header-height'): getComputedStyle(this, '--app-header-height');
        }
        return height;
      })();

      let tl = new TimelineLite();

      switch(requestedIndex) {
        case 0:
          tl.staggerTo([layers[1], layers[2], picture], .3, {opacity:0, ease: Power1.easeOut});
          break;
        case 1:
          tl.staggerTo([layers[0], layers[2]], .3, {opacity:0, ease: Power1.easeIn});
          break;
        case 2:
          tl.staggerTo([layers[0], layers[1], picture], .3, {opacity:0, ease: Power1.easeOut});
          break;
      }

      tl.to(picture, .3, {opacity:0, ease: Power1.easeNone})
      .to(this.shadowRoot.getElementById('waves'), .5, {
        "transform": 'translateY(-' + (document.documentElement.clientHeight * 2 - parseInt(headerHeight)) + 'px)',
        ease: Power1.easeIn
      });

//      tl.play();
      this.exitTimeline = tl;
      return tl;
    }

      /**
       * The methods below should be used once I figure out how to reset animations, built with Web Animations API
       * */

//      entryAnimation() {
//        const timing = {
//          duration: 300,
//          fill: "forwards",
//          ease: "ease-out"
//        };
//
//        const initSettings = {
//          'intro': {
//            'transform':  'translateY(100%)',
//            'opacity':  '0'
//          },
//          'character': {
//            'transform':  'translateY(100%)',
//            'opacity':  '0'
//          },
//          'waves': {
//            'opacity': '0'
//          }
//        };
//
//        for (let key in initSettings) {
//          if (initSettings.hasOwnProperty(key)) {
//            for (let prop in initSettings[key]) {
//              if (initSettings[key].hasOwnProperty(prop)) {
//                this.shadowRoot.getElementById(key).style.setProperty(prop, initSettings[key][prop]);
//              }
//            }
//          }
//        }
//
//        const introAnimation = new KeyframeEffect(this.$.intro, {
//          'transform': ['translateY(100%)', 'translateY(0)'],
//          'opacity': [0,1]
//        }, timing);
//        const charAnimation = new KeyframeEffect(this.$.character, {
//          'transform': ['translateY(100%)', 'translateY(0)'],
//          'opacity': [0,1]
//        }, timing);
//        const wavesAnimation = new KeyframeEffect(this.$.waves, {
//          'opacity': [0,1]
//        }, timing);
//        const group = new GroupEffect([introAnimation, charAnimation]);
//        const animation = new SequenceEffect([group, wavesAnimation]);
//
//        this.style.setProperty('opacity', 1);
//        document.timeline.play(animation);
//      }
//    resetExitAnimation() {
//      // reset output of  _prepareExitAnimation();
//      this.shadowRoot.getElementById('transitionBackdrop').style.backgroundColor = 'transparent';
//
//      // reset character and waves
//      this.shadowRoot.querySelector('#character img').animate({
//        "opacity": [0, 1]
//      }, {duration: 0, fill: 'forwards'});
//      const waves = this.shadowRoot.getElementById('waves');
//      waves.animate({
//        "opacity": [0,1],
//        "transform": ['translateY(-100%)', 'translateY(0)']
//      },  {duration: 0, fill: 'forwards'});
//
//      // reset separate layers
//      const layers = this.shadowRoot.querySelectorAll('g[id$="-layer"]');
//      for (let i = 0, l = layers.length; i < l; i++) {
//        layers[i].animate({
//          "opacity": [0,1]
//        }, {duration: 0, fill: 'forwards'});
//      }
//    }
//
//    exitAnimation(requestedPage) {
//      const requestedIndex = this._prepareExitAnimation(requestedPage);
//
//      const layers = this.shadowRoot.querySelectorAll('g[id$="-layer"]');
//      const picture = this.shadowRoot.querySelector('#character img');
//
//      const dissolveWaveTimings = this.animationConfig.dissolveWaves.options;
//      const dissolveWaveKeyframes = this.animationConfig.dissolveWaves.keyframes;
//
//      const moveEffect = new KeyframeEffect(this.shadowRoot.getElementById('waves'), this.animationConfig.moveWaves.keyframes, this.animationConfig.moveWaves.options);
//      const pictureEffect = new KeyframeEffect(picture, this.animationConfig.dissolvePicture.keyframes, this.animationConfig.dissolvePicture.options);
//
//      let dissolveEffects;
//
//      switch(requestedIndex) {
//        case 0:
//          dissolveEffects = [
//            new KeyframeEffect(layers[1], dissolveWaveKeyframes, dissolveWaveTimings),
//            new KeyframeEffect(layers[2], dissolveWaveKeyframes, dissolveWaveTimings),
//          ];
//          break;
//        case 1:
//          dissolveEffects = [
//            new KeyframeEffect(layers[0], dissolveWaveKeyframes, dissolveWaveTimings),
//            new KeyframeEffect(layers[2], dissolveWaveKeyframes, dissolveWaveTimings),
//          ];
//          break;
//        case 2:
//          dissolveEffects = [
//            new KeyframeEffect(layers[0], dissolveWaveKeyframes, dissolveWaveTimings),
//            new KeyframeEffect(layers[1], dissolveWaveKeyframes, dissolveWaveTimings),
//          ];
//          break;
//      }
//
//      const groupDissolveAnimation = new GroupEffect(dissolveEffects);
//      const groupMoveAnimation = new GroupEffect([pictureEffect, moveEffect]);
//
//      return new SequenceEffect([groupDissolveAnimation, groupMoveAnimation]);
//    }

  }
  customElements.define(MyHome.is, MyHome);

</script>
