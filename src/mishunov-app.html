<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">


<link rel="import" href="my-header.html">
<link rel="import" href="my-footer.html">
<link rel="import" type="css" href="shared-styles.html">

<script src="../bower_components/web-animations-js/web-animations-next-lite.min.js"></script>

<dom-module id="mishunov-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        /*background: var(--app-primary-color);*/
        background-color: #FFE11A;
        color: var(--app-primary-font-color);
        position: relative;
        box-sizing: border-box;
        min-height: 100%;
        padding: 0 0 130px; /* 130px is the height of the footer on mobile */
      }

      @media screen and (min-width: 768px) {
        :host {
          padding-bottom: 218px;  /* 218px is the height of the footer on devices with larger screens */
        }
      }
      @media screen and (min-width: 2000px) {
        iron-pages .react-to-width {
          -webkit-column-count: 2;
          -moz-column-count: 2;
          column-count: 2;
          -moz-column-gap: 2em;
          -webkit-column-gap: 2em;
          column-gap: 2em;
        }
      }
      /* We should override even the media queries for this case */
      :host([page="home"]) {
        padding-bottom: 0;
      }
    </style>

    <app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>
    <app-route
      route="{{route}}"
      pattern="[[rootPath]]:page"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>


    <my-header id="header" class="react-to-width" page="[[page]]" role="navigation"></my-header>


    <iron-pages
      selected="[[page]]"
      attr-for-selected="name"
      fallback-selection="view404"
      role="main">

      <my-home id="home" name="home"></my-home>
      <my-working class="react-to-width" name="working"></my-working>
      <my-speaking class="react-to-width" name="speaking"></my-speaking>
      <my-writing class="react-to-width" name="writing"></my-writing>
      <my-view404 class="react-to-width" name="view404"></my-view404>
    </iron-pages>

    <my-footer page="[[page]]"></my-footer>

  </template>

  <script>

    // performance logging
    window.performance && performance.mark && performance.mark('mishunov-app - before register');

    /**
     * @customElement
     * @polymer
     */
    class MishunovApp extends Polymer.Element {

      static get is() { return 'mishunov-app'; }

      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged'
          },
          routeData: Object,
          subroute: String,
          // This shouldn't be necessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String
        };
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)'
        ];
      }

      constructor() {
        super();
        window.performance && performance.mark && performance.mark('mishunov-app.created');
      }

      ready () {
        super.ready();
        this.addEventListener('dom-change', (e)=>this._domChange(e));
        this.addEventListener('navigation-to-home-requested', (e)=>this._animateToHomeNavigation(e));
        this.addEventListener('navigation-from-home-requested', (e)=>this._animateFromHomeNavigation(e));
        this.addEventListener('navigation-between-pages-requested', (e)=>this._animateBetweenPagesNavigation(e));
      }

      _routePageChanged(page) {
        // If no page was found in the route data, page will be an empty string.
        // Deault to 'home' in that case.
        this.page = page || 'home';
      }
      _pageChanged(page) {
        // Load page import on demand. Show 404 page if fails
        let resolvedPageUrl = this.resolveUrl('my-' + page + '.html');
        Polymer.importHref(
          resolvedPageUrl,
          this._pageLoaded.bind(this),
          this._showPage404.bind(this),
          true);
      }

      _pageLoaded() {
        this._ensureLazyLoaded();
      }

      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              // Register service worker if supported.
//              if ('serviceWorker' in navigator) {
//                navigator.serviceWorker.register('service-worker.js', {scope: '/'});
//              }
//              this._notifyNetworkStatus();
              this.loadComplete = true;
            });
          });
        }
      }

      _showPage404() {
        this.page = 'view404';
      }

      // This is for performance logging only.
      _domChange(e) {
        if (window.performance && performance.mark && !this.__loggedDomChange) {
          let target = e.composedPath()[0];
          let host = target.getRootNode().host;
          if (host && host.localName.match(this.page)) {
            this.__loggedDomChange = true;
            performance.mark(host.localName + '.domChange');
          }
        }
      }

      navigateToAPage(requested, current) {
        window.history.pushState({}, null, '/' + requested);
        const elInDom = this.shadowRoot.querySelector(`[name="${requested}"]`);
        const currentInDom = this.shadowRoot.querySelector(`[name="${current}"]`);
        if (elInDom.shadowRoot) {
          elInDom.entryAnimation();
        }
        currentInDom.resetExitAnimation();

        // `location-changed` â€“ event to communicate to <app-location>
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      _animateToHomeNavigation() {
//        if (this.$.home.shadowRoot) {
//        if(this.$.home.shadowRoot) {
//          Polymer.Async.microTask.run(() => {
//            this.$.home.resetExitAnimation();
//            this.$.home.style.setProperty('opacity', 0);
//          });
//        }
          const headerTimeline = this.$.header.exitAnimation();
          const selectedPage = this.shadowRoot.querySelector('iron-pages').selectedItem;
          const pageTimeline = selectedPage.exitAnimation();
//          const animGroup = new GroupEffect([headerKeyframes, pageKeyframes]);

          const tl = new TimelineLite({
            onComplete: () => {
              this.navigateToAPage('home', this.shadowRoot.querySelector('iron-pages').selected);
            }
          });

          tl.add(headerTimeline)
            .add(pageTimeline);
          tl.play();
//
//          const anim = document.timeline.play(headerKeyframes);
//          const resolvedPageUrl = this.resolveUrl('/src/my-home.html');
//          let homePageContents;
//          Polymer.importHref(
//              resolvedPageUrl,
//              function () {
//                debugger;
//              },
//              null,
//              true);

//          const anim = document.timeline.play(animGroup);
//
//          anim.onfinish = (e) => {
//            this.navigateToAPage('home', e);
//          };
      }

      _animateFromHomeNavigation(e) {
        const requested = e.detail.requested;
        const headerTimeline = this.$.header.entryAnimation(requested);
        const pageTimeline = this.$.home.exitAnimation(requested);
        const tl = new TimelineLite({
          onComplete: () => {
            this.navigateToAPage(requested, 'home');
          }
        });

        tl.add(pageTimeline, "page")
          .add(headerTimeline, "-=.3");

        tl.play();

//        const animGroup = new GroupEffect([pageKeyframes, headerKeyframes]);

//        const anim = document.timeline.play(animGroup);
//        this.$.home.addEventListener('exit-animation-finished', () => {
//          const anim = document.timeline.play(headerKeyframes);
//
//          anim.onfinish = (e) => {
//            this.navigateToAPage(requested, 'home', e);
//          };
//        });
//
//        this.$.home.exitAnimation(requested);
      }

      _animateBetweenPagesNavigation(e) {
        const requested = e.detail.requested;
//        const headerKeyframes = this.$.header.navigateBetweenPagesAnimation(requested);
//        const animGroup = new GroupEffect(headerKeyframes);
//
//        const anim = document.timeline.play(animGroup);

        this.$.header.betweenAnimation(requested);
        this.navigateToAPage(requested);
//        const anim = document.timeline.play(animGroup);

//        anim.onfinish = (e) => {
//          this.navigateToAPage(requested);
//        };
      }

    }

    window.customElements.define(MishunovApp.is, MishunovApp);
  </script>
</dom-module>
