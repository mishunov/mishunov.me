<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-section-title.html">
<link rel="import" href="my-navigation.html">
<link rel="import" href="my-character.html">

<dom-module id="my-header">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        margin: 0 0 48px;
        padding: 0;
        position: relative;
        z-index: 2;
        --my-navigation-anchors-color: var(--app-primary-font-color);
        @apply --app-header;
      }
      :host([page="working"]),
      :host([page="writing"]) {
        --my-navigation-anchors-color: var(--app-alt-font-color);
      }
      :host([no-transition]) {
        transition: none;
      }
      [main-title] {
        pointer-events: auto;
        position: relative;
      }
      [main-title] a {
        font-family: "Oneday Condensed", serif;
        font-size: 22px;
        line-height: 36px;
        color: var(--my-navigation-anchors-color);
      }
      [main-title] iron-icon {
        margin-bottom:.25em;
      }
      app-header {
        height: var(--app-header-height-mobile);
        position: relative;
        z-index: 2;
      }
      app-toolbar {
        padding: 0;
        height: 36px;
        @apply --layout-end-justified;
        @apply --layout-end;
      }

      /*
      ** Sections
      */
      :host([page="working"]),
      :host([page="writing"]) {
        color: var(--app-alt-font-color);
      }
      :host([page="speaking"]) {
        background-color: var(--app-lime-color);
      }
      :host([page="working"]) {
        background-color: var(--app-blue-color);
      }
      :host([page="writing"]) {
        background-color: var(--app-green-color);
      }
      /* end Sections */

      @media screen and (min-width: 768px) {
        :host {
          background-image: url('/images/dashed-border.svg'), url('/images/header-bottom.png');
        }
        app-header {
          height: var(--app-header-height);
        }
        app-toolbar {
          height: 47px;
        }
        [main-title] a {
          line-height: auto;
        }
      }
      @media screen and (min-width: 1024px) {
        :host {
          margin-bottom: 110px;
        }
      }
      @media screen and (min-width: 1758px) {
        :host {
          background-size: auto;
        }
      }

      /*
      ** Home Page
      ** (we should override all styles incl. responsive ones, hence these go after media queries)
      */

      :host([page="home"]) {
        background-image: none;
      }
      :host([page="home"]):after {
        display: none;
      }
      :host([page="home"]) app-header {
        height: auto;
      }
      /*:host([page="home"]) app-toolbar {*/
        /*@apply --layout-center-justified;*/
      /*}*/
    </style>

    <app-header id="header" reveal>
      <app-toolbar>
        <div main-title hidden="[[isHomePage]]">
          <a class="hide-on-mobile" href="/" aria-label="Go Home :)" on-click="handleClick">Denys Mishunov</a>
          <a class="show-on-mobile" name="home" href="/" title="Go home :)" on-click="handleClick"><iron-icon icon="home"></iron-icon></a>
        </div>
        <my-navigation id="nav" page="[[page]]"></my-navigation>
      </app-toolbar>
      <my-section-title id="sectiontitle" page="[[page]]" hidden="[[isHomePage]]"></my-section-title>

      <template is="dom-if" if="[[!isHomePage]]">
        <my-character id="character" page="[[page]]" on-finished-animation="_characterIsDone"></my-character>
        <!--<my-character id="character"></my-character>-->
      </template>
    </app-header>

  </template>
  <script>
    class MyHeader extends Polymer.Element {
      static get is() { return 'my-header'; }

      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageIsSet'
          },
          isHomePage: {
            type: Boolean,
            computed: '_isHomePage(page)'
          }
        }
      }
      _isHomePage(page) {
        return page === 'home' || false;
      }

      _characterIsDone(event) {
        this.$.sectiontitle.tweenSectionsTitle();
      }

      /** This is run when we get *to* /home or when the get to a new page *from* home */
      _pageIsSet(newPage, oldPage) {
        if (newPage === 'home') {
          const header = this.shadowRoot.getElementById('header');
          const nav = this.shadowRoot.getElementById('nav');

          const rectHeader = header.getBoundingClientRect();
          const rectNav = nav.getBoundingClientRect();
          const shift = (rectNav.left - rectHeader.left)/2;
          if (shift !== 0) {
            nav.style.setProperty('transform', `translateX(${shift * -1}px)`);
          }
        } else if(!oldPage || oldPage === 'home') {
          this.style.setProperty('background-color', this.__getSectionsColor(newPage));
        }
      }

      __getSectionsColor(section) {
        return section === 'working' && getComputedStyle(this).getPropertyValue("--app-blue-color") ||
            section === 'writing' && getComputedStyle(this).getPropertyValue("--app-green-color") ||
            section === 'speaking' && getComputedStyle(this).getPropertyValue("--app-lime-color") ||
            section === 'home' && 'transparent';
      }

      entryAnimation(requestedPage) {
        const nav = this.shadowRoot.getElementById('nav');
        const reversedColor = requestedPage === 'working' || requestedPage === 'writing'? '#fff': '#000';
        const tl = new TimelineLite();

        tl.to(nav, .5, {
            "transform": "translateX(0px)",
            ease: Power3.easeOut
          })
          .to(nav, .5, {
            "--my-navigation-anchors-color": reversedColor,
            ease: Power0.easeNone
          }, "-=.5");
        this.entryAnimation = tl;
        return tl;
      }
//      entryAnimation(requestedPage) {
//        const nav = this.shadowRoot.getElementById('nav');
//        return nav.animateTransitionFromHome(requestedPage);
//      }

      exitAnimation() {
        const tl = new TimelineLite();
        const nav = this.shadowRoot.getElementById('nav');
        const logo = this.shadowRoot.querySelector('[main-title] a');
        const sectionTitle = this.shadowRoot.getElementById('sectiontitle');
        const character = this.shadowRoot.getElementById('character');
        const rectHeader = this.getBoundingClientRect();
        const rectNav = nav.getBoundingClientRect();
        const shift = (rectNav.left - rectHeader.left)/2;
//        const navAnimation = nav.animateTransitionToHome(timing);

        tl.staggerTo([sectionTitle, character, logo], .3, {opacity: 0})
          .to(nav, .3, {"x": (() => {
            if (shift !== 0) {
              return `${shift * -1}px`;
            }
          })(), ease: Power3.easeOut})
          .to(nav, .3, {"--my-navigation-anchors-color": "#000"}, "-=.3")
          .to(this, .3, {backgroundColor: 'transparent'}, "-=.3")
          .to(this, 0, {backgroundImage: 'none'});

        return tl;
//        const timing = {
//          duration: 300,
//          fill: "forwards"
//        };
//
//        const nav = this.shadowRoot.getElementById('nav');
//        const logo = this.shadowRoot.querySelector('[main-title] a');
//        const sectionTitle = this.shadowRoot.getElementById('sectiontitle');
//        const character = this.shadowRoot.getElementById('character');
//        const navAnimation = nav.animateTransitionToHome(timing);
//        let opacityLogo;
//
//        const opacityTitle = new KeyframeEffect(sectionTitle, {
//          "opacity": [1, 0]
//        }, timing);
//        const opacityCharacter = new KeyframeEffect(character, {
//          "opacity": [1, 0]
//        }, timing);
//        const moveBg = new SequenceEffect([
//          new KeyframeEffect(this, {
//            "backgroundColor": [this.style.getPropertyValue('background-color'), 'transparent']
//          }, timing),
//          new KeyframeEffect(this, {
//            "backgroundImage": ['none', 'none']
//          }, {duration: 0, fill: "forwards"})
//        ]);
//
//        if (logo) {
//          opacityLogo = new KeyframeEffect(logo, {
//            "opacity": [1, 0]
//          }, timing);
//          return new GroupEffect([navAnimation, opacityLogo, opacityTitle, opacityCharacter, moveBg]);
//        } else {
//          return navAnimation;
//        }
      }

      betweenAnimation(requestedPage) {
        const targetBg = this.__getSectionsColor(requestedPage);
        return TweenLite.to(this, 1, {
          backgroundColor: targetBg.trim(),
          ease: Power1.easeOut
        });
      }

      handleClick(e) {
        e.preventDefault();
        e.stopPropagation();
        this.dispatchEvent(new CustomEvent('navigation-to-home-requested', {bubbles: true, composed: true}));
      }
    }
    customElements.define(MyHeader.is, MyHeader);
  </script>
</dom-module>