<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-section-title.html">
<link rel="import" href="my-navigation.html">
<link rel="import" href="my-character.html">

<dom-module id="my-header">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        margin: 0 0 48px;
        padding: 0;
        position: relative;
        background-color: transparent;
        background-position: 100% 100%;
        background-repeat: repeat-x;
        /*transition: background-color .3s ease-out;*/
        --my-navigation-anchors-color: var(--app-primary-font-color);
        /*background-image: url('/images/header-bottom-mobile.png');*/
        /*--iron-icon-width: 15px;*/
        /*--iron-icon-height: 15px;*/
        @apply --app-header;
      }
      :host([page="working"]),
      :host([page="writing"]) {
        --my-navigation-anchors-color: var(--app-alt-font-color);
      }
      :host([no-transition]) {
        transition: none;
      }
      :host:after {
        content: "";
        display: block;
        position: absolute;
        z-index: 1;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background: transparent url('/images/dashed-border-mobile.svg') 100% 100% repeat-x;
        background-size: cover;
      }
      [main-title] {
        pointer-events: auto;
        position: relative;
      }
      [main-title] a {
        font-family: "Oneday Condensed", serif;
        font-size: 22px;
        line-height: 36px;
        color: var(--my-navigation-anchors-color);
      }
      [main-title] iron-icon {
        margin-bottom:.25em;
      }
      app-header {
        height: var(--app-header-height-mobile);
        position: relative;
        z-index: 2;
      }
      app-toolbar {
        padding: 0;
        height: 36px;
        @apply --layout-end-justified;
        @apply --layout-end;
      }

      /*
      ** Sections
      */
      :host([page="working"]),
      :host([page="writing"]) {
        color: var(--app-alt-font-color);
      }
      /*:host([page="speaking"]) {*/
        /*background-color: var(--app-lime-color);*/
      /*}*/
      /*:host([page="working"]) {*/
        /*background-color: var(--app-blue-color);*/
      /*}*/
      /*:host([page="writing"]) {*/
        /*background-color: var(--app-green-color);*/
      /*}*/
      /* end Sections */

      @media screen and (min-width: 768px) {
        :host {
          background-image: url('/images/header-bottom.png');
        }
        :host:after {
          background-image: url('/images/dashed-border.svg');
        }
        app-header {
          height: var(--app-header-height);
        }
        app-toolbar {
          height: 47px;
        }
        [main-title] a {
          line-height: auto;
        }
        /*[main-title] {*/
          /*position: fixed;*/
          /*left: 50px;*/
          /*top: 21px;*/
        /*}*/
      }
      @media screen and (min-width: 1024px) {
        :host {
          margin-bottom: 110px;
        }
      }
      @media screen and (min-width: 1758px) {
        :host:after {
          background-size: auto;
        }
      }

      /*
      ** Home Page
      ** (we should override all styles incl. responsive ones, hence these go after media queries)
      */

      :host([page="home"]) {
        background-image: none;
      }
      :host([page="home"]):after {
        display: none;
      }
      :host([page="home"]) app-header {
        height: auto;
      }
      /*:host([page="home"]) app-toolbar {*/
        /*@apply --layout-center-justified;*/
      /*}*/
    </style>

    <app-header id="header" reveal>
      <app-toolbar>
        <div main-title hidden="[[isHomePage]]">
          <a class="hide-on-mobile" href="/" aria-label="Go Home :)" on-click="handleClick">Denys Mishunov</a>
          <a class="show-on-mobile" name="home" href="/" title="Go home :)" on-click="handleClick"><iron-icon icon="home"></iron-icon></a>
        </div>
        <my-navigation id="nav" page="[[page]]"></my-navigation>
      </app-toolbar>
      <my-section-title page="[[page]]" hidden="[[isHomePage]]"></my-section-title>

      <template is="dom-if" if="[[!isHomePage]]">
        <my-character id="character" page="[[page]]"></my-character>
        <!--<my-character id="character"></my-character>-->
      </template>
    </app-header>

  </template>
  <script>
    class MyHeader extends Polymer.Element {
      static get is() { return 'my-header'; }

      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageIsSet'
          },
          isHomePage: {
            type: Boolean,
            computed: '_isHomePage(page)'
          }
        }
      }
      _isHomePage(page) {
        return page === 'home' || false;
      }

      _pageIsSet(newPage, oldPage) {
        if (newPage === 'home') {
          const header = this.shadowRoot.getElementById('header');
          const nav = this.shadowRoot.getElementById('nav');

          const rectHeader = header.getBoundingClientRect();
          const rectNav = nav.getBoundingClientRect();
          const shift = (rectNav.left - rectHeader.left)/2;

          if (shift !== 0) {
            nav.style.setProperty('transform', `translateX(${shift * -1}px)`);
          }
        } else if(!oldPage || oldPage === 'home') {
          this.style.setProperty('background-color', this.__getSectionsColor(newPage));
        }
      }

      __getSectionsColor(section) {
        return section === 'working' && getComputedStyle(this).getPropertyValue("--app-blue-color") ||
            section === 'writing' && getComputedStyle(this).getPropertyValue("--app-green-color") ||
            section === 'speaking' && getComputedStyle(this).getPropertyValue("--app-lime-color") ||
            section === 'home' && 'transparent';
      }

      navigateFromHomepageAnimation(requestedPage) {
        const nav = this.shadowRoot.getElementById('nav');
        return nav.animateTransitionFromHome(requestedPage);
      }

      navigateToHomepageAnimation() {
        const nav = this.shadowRoot.getElementById('nav');
        return nav.animateTransitionToHome();
      }

      _transitionBgColor(requestedPage) {
        const targetBg = this.__getSectionsColor(requestedPage);
        return TweenLite.to(this, 1, {
          backgroundColor: targetBg.trim(),
          ease: Power1.easeOut
        });
      }

      navigateBetweenPagesAnimation(requestedPage) {
        return this._transitionBgColor(requestedPage);
      }

      handleClick(e) {
        e.preventDefault();
        e.stopPropagation();
        this.dispatchEvent(new CustomEvent('navigation-to-home-requested', {bubbles: true, composed: true}));
      }
    }
    customElements.define(MyHeader.is, MyHeader);
  </script>
</dom-module>